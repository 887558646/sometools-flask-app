<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡æŠ•è³‡å·¥å…·æ•´åˆå¹³å°</title>
    <style>
        /* ============================================
           è¨­è¨ˆç³»çµ± - CSS è®Šæ•¸å®šç¾©
           ============================================ */
        :root {
            /* è‰²å½©ç³»çµ± */
            --color-primary: #667eea;
            --color-primary-dark: #764ba2;
            --color-success: #27ae60;
            --color-success-light: #2ecc71;
            --color-warning: #f59e0b;
            --color-error: #e74c3c;
            --color-error-dark: #c0392b;
            --color-info: #3b82f6;
            
            /* èƒŒæ™¯è‰² */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f0f9ff;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-gradient-success: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            --bg-gradient-error: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            --bg-gradient-warning: linear-gradient(135deg, #fef3c7 0%, #ffffff 100%);
            
            /* æ–‡å­—é¡è‰² */
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-tertiary: #555;
            --text-inverse: #ffffff;
            
            /* é‚Šæ¡†é¡è‰² */
            --border-light: #e0e0e0;
            --border-medium: #d0d0d0;
            --border-focus: #667eea;
            
            /* å­—é«”ç³»çµ± */
            --font-family: 'Segoe UI', 'Microsoft JhengHei', Tahoma, Geneva, Verdana, sans-serif;
            --font-size-h1: 32px;
            --font-size-h2: 24px;
            --font-size-h3: 18px;
            --font-size-body: 16px;
            --font-size-small: 14px;
            --font-size-caption: 12px;
            --font-weight-bold: 700;
            --font-weight-semibold: 600;
            --font-weight-medium: 500;
            --font-weight-normal: 400;
            
            /* é–“è·ç³»çµ± */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 24px;
            --spacing-2xl: 32px;
            --spacing-3xl: 48px;
            --spacing-4xl: 64px;
            
            /* åœ“è§’ç³»çµ± */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            
            /* é™°å½±ç³»çµ± */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.15);
            --shadow-xl: 0 10px 40px rgba(0, 0, 0, 0.2);
            
            /* éæ¸¡å‹•ç•« */
            --transition-fast: 0.2s ease;
            --transition-base: 0.3s ease;
            --transition-slow: 0.5s ease;
        }
        
        /* ============================================
           åŸºç¤é‡ç½®èˆ‡å…¨åŸŸæ¨£å¼
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-family);
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: var(--spacing-lg);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        /* ============================================
           ä¸»å®¹å™¨èˆ‡é é¢æ¨™é¡Œ
           ============================================ */
        .main-container {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            overflow: hidden;
        }
        
        .page-header {
            background: var(--bg-gradient);
            color: var(--text-inverse);
            padding: var(--spacing-3xl) var(--spacing-2xl);
            text-align: center;
        }
        
        .page-header h1 {
            font-size: var(--font-size-h1);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--spacing-md);
            color: var(--text-inverse);
        }
        
        .page-header p {
            font-size: var(--font-size-body);
            opacity: 0.9;
        }
        
        /* ============================================
           æ¨™ç±¤é å°è¦½
           ============================================ */
        .tabs-container {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-light);
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .tabs-container::-webkit-scrollbar {
            display: none;
        }
        
        .tab-button {
            flex: 1;
            min-width: 150px;
            padding: var(--spacing-lg) var(--spacing-xl);
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            font-size: var(--font-size-body);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all var(--transition-base);
            white-space: nowrap;
        }
        
        .tab-button:hover {
            background: rgba(102, 126, 234, 0.1);
            color: var(--color-primary);
        }
        
        .tab-button.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
            background: var(--bg-primary);
        }
        
        .tab-content {
            display: none;
            padding: var(--spacing-3xl) var(--spacing-2xl);
            animation: fadeIn var(--transition-base);
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* ============================================
           å€å¡Šæ¨£å¼
           ============================================ */
        .section {
            margin-bottom: var(--spacing-3xl);
        }
        
        .section:last-child {
            margin-bottom: 0;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            padding-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--border-light);
        }
        
        .section-header h2 {
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
        }
        
        .section-header .icon {
            font-size: 28px;
        }
        
        .section-description {
            color: var(--text-secondary);
            font-size: var(--font-size-small);
            margin-top: var(--spacing-sm);
            margin-bottom: var(--spacing-xl);
        }
        
        /* ============================================
           è¡¨å–®å…ƒä»¶
           ============================================ */
        .form-group {
            margin-bottom: var(--spacing-xl);
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary);
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-body);
        }
        
        .form-label .required {
            color: var(--color-error);
            margin-left: var(--spacing-xs);
        }
        
        .form-input {
            width: 100%;
            padding: var(--spacing-lg);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: var(--font-size-body);
            font-family: var(--font-family);
            transition: all var(--transition-base);
            background: var(--bg-primary);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-input::placeholder {
            color: var(--text-secondary);
        }
        
        .form-helper {
            margin-top: var(--spacing-sm);
            font-size: var(--font-size-small);
            color: var(--text-secondary);
        }
        
        /* ============================================
           æŒ‰éˆ•å…ƒä»¶
           ============================================ */
        .btn {
            width: 100%;
            padding: var(--spacing-lg) var(--spacing-xl);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-body);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all var(--transition-base);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            min-height: 44px; /* æ‰‹æ©Ÿè§¸æ§å‹å–„ */
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: var(--bg-gradient);
            color: var(--text-inverse);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: var(--bg-gradient-warning);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: linear-gradient(135deg, #fde68a 0%, #fef3c7 100%);
        }
        
        .btn-success {
            background: var(--bg-gradient-success);
            color: var(--text-inverse);
        }
        
        .btn-loading {
            position: relative;
            color: transparent;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid var(--text-inverse);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ============================================
           è¨Šæ¯æç¤ºå…ƒä»¶
           ============================================ */
        .alert {
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-lg);
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-md);
            animation: slideIn var(--transition-base);
        }
        
        .alert-error {
            background: linear-gradient(135deg, #fee 0%, #fdd 100%);
            border-left: 4px solid var(--color-error);
            color: var(--color-error-dark);
        }
        
        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-left: 4px solid var(--color-success);
            color: #155724;
        }
        
        .alert-info {
            background: var(--bg-tertiary);
            border-left: 4px solid var(--color-info);
            color: #1e40af;
        }
        
        .alert-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-xs);
        }
        
        .alert-message {
            font-size: var(--font-size-small);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* ============================================
           è¼‰å…¥ç‹€æ…‹
           ============================================ */
        .loading-container {
            text-align: center;
            padding: var(--spacing-3xl);
            display: none;
        }
        
        .loading-container.active {
            display: block;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-light);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto var(--spacing-lg);
        }
        
        .loading-text {
            color: var(--text-secondary);
            font-size: var(--font-size-body);
        }
        
        /* ============================================
           çµæœå€å¡Š
           ============================================ */
        .results-container {
            margin-top: var(--spacing-3xl);
            display: none;
        }
        
        .results-container.show {
            display: block;
            animation: fadeIn var(--transition-base);
        }
        
        .results-header {
            text-align: center;
            margin-bottom: var(--spacing-2xl);
        }
        
        .results-header h3 {
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }
        
        .results-header p {
            color: var(--text-secondary);
            font-size: var(--font-size-small);
        }
        
        /* ============================================
           è¡¨æ ¼æ¨£å¼
           ============================================ */
        .table-wrapper {
            overflow-x: auto;
            margin-top: var(--spacing-xl);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-primary);
            min-width: 600px;
        }
        
        thead {
            background: var(--bg-gradient);
            color: var(--text-inverse);
        }
        
        thead th {
            padding: var(--spacing-lg);
            text-align: left;
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-small);
        }
        
        tbody td {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-light);
            font-size: var(--font-size-body);
        }
        
        tbody tr:hover {
            background: var(--bg-secondary);
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        .table-support thead {
            background: var(--bg-gradient-success);
            color: white;
        }
        
        .table-support thead th {
            color: white;
        }
        
        .table-resistance thead {
            background: var(--bg-gradient-error);
            color: white;
        }
        
        .table-resistance thead th {
            color: white;
        }
        
        .table-price {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-body);
        }
        
        .price-support {
            color: var(--color-success);
        }
        
        .price-resistance {
            color: var(--color-error);
        }
        
        /* ============================================
           å¡ç‰‡å…ƒä»¶
           ============================================ */
        .card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-md);
        }
        
        .card-header {
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-lg);
            border-bottom: 1px solid var(--border-light);
        }
        
        .card-title {
            font-size: var(--font-size-h3);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
        }
        
        .metric-card {
            padding: var(--spacing-xl);
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .metric-label {
            font-size: var(--font-size-small);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
        }
        
        /* ============================================
           è‚¡ç¥¨è¨Šè™Ÿå¡ç‰‡
           ============================================ */
        .signal-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-top: var(--spacing-xl);
            box-shadow: var(--shadow-md);
        }
        
        .stock-header {
            background: var(--bg-gradient);
            color: var(--text-inverse);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-xl);
        }
        
        .stock-header h3 {
            font-size: var(--font-size-h3);
            font-weight: var(--font-weight-semibold);
            margin: 0;
        }
        
        .signal-group {
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-xl);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--color-primary);
        }
        
        .signal-group:last-child {
            margin-bottom: 0;
        }
        
        .signal-group-title {
            font-size: var(--font-size-h3);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 2px solid var(--border-light);
        }
        
        .signal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .signal-item:last-child {
            border-bottom: none;
        }
        
        .signal-label {
            font-weight: var(--font-weight-medium);
            color: var(--text-tertiary);
        }
        
        .signal-value {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-body);
        }
        
        .signal-yes {
            color: var(--color-success);
        }
        
        .signal-no {
            color: var(--color-error);
        }
        
        /* ============================================
           è³‡è¨Šæ¡†
           ============================================ */
        .info-box {
            background: var(--bg-secondary);
            border-left: 4px solid var(--color-primary);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-xl);
            border-radius: var(--radius-sm);
        }
        
        .info-box p {
            margin: var(--spacing-xs) 0;
            color: var(--text-tertiary);
            font-size: var(--font-size-small);
        }
        
        .info-box strong {
            color: var(--text-primary);
        }
        
        /* ============================================
           éŸ¿æ‡‰å¼è¨­è¨ˆ
           ============================================ */
        @media (max-width: 768px) {
            body {
                padding: var(--spacing-sm);
            }
            
            .main-container {
                border-radius: var(--radius-lg);
            }
            
            .page-header {
                padding: var(--spacing-2xl) var(--spacing-lg);
            }
            
            .page-header h1 {
                font-size: 24px;
            }
            
            .tab-content {
                padding: var(--spacing-xl) var(--spacing-lg);
            }
            
            .tab-button {
                min-width: 120px;
                padding: var(--spacing-md) var(--spacing-lg);
                font-size: var(--font-size-small);
            }
            
            .section-header h2 {
                font-size: 20px;
            }
            
            .metric-grid {
                grid-template-columns: 1fr;
            }
            
            .metric-value {
                font-size: 24px;
            }
            
            .table-wrapper {
                margin-left: calc(-1 * var(--spacing-lg));
                margin-right: calc(-1 * var(--spacing-lg));
                border-radius: 0;
            }
            
            table {
                min-width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .page-header h1 {
                font-size: 20px;
            }
            
            .tab-button {
                min-width: 100px;
                font-size: var(--font-size-caption);
            }
        }
        
        /* ============================================
           å·¥å…·é¡åˆ¥
           ============================================ */
        .text-center {
            text-align: center;
        }
        
        .mt-lg {
            margin-top: var(--spacing-xl);
        }
        
        .mb-lg {
            margin-bottom: var(--spacing-xl);
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- é é¢æ¨™é¡Œ -->
        <div class="page-header">
        <h1>ğŸ“ˆ å°è‚¡æŠ•è³‡å·¥å…·æ•´åˆå¹³å°</h1>
            <p>å°ˆæ¥­çš„æŠ€è¡“åˆ†æèˆ‡æ—ç¾¤ç†±åº¦åˆ†æå·¥å…·</p>
        </div>
        
        <!-- æ¨™ç±¤é å°è¦½ -->
        <div class="tabs-container">
            <button class="tab-button {% if active_tab == 'fibonacci' %}active{% endif %}" onclick="switchTab('fibonacci')" id="tab-fibonacci">
                ğŸ“Š æ–æ³¢é‚£å¥‘è¨ˆç®—
            </button>
            <button class="tab-button {% if active_tab == 'signals' %}active{% endif %}" onclick="switchTab('signals')" id="tab-signals">
                ğŸ“ˆ è‚¡ç¥¨è¨Šè™Ÿ
            </button>
            <button class="tab-button {% if active_tab == 'themes' %}active{% endif %}" onclick="switchTab('themes')" id="tab-themes">
                ğŸ”¥ æ—ç¾¤åˆ†æ
            </button>
        </div>
        
        <!-- æ–æ³¢é‚£å¥‘è¨ˆç®—æ¨™ç±¤é  -->
        <div id="content-fibonacci" class="tab-content {% if active_tab == 'fibonacci' %}active{% endif %}">
        <div class="section">
                <div class="section-header">
                    <span class="icon">ğŸ“Š</span>
                    <h2>æ–æ³¢é‚£å¥‘æ”¯æ’ä½èˆ‡å£“åŠ›ä½è¨ˆç®—å™¨</h2>
                </div>
                <p class="section-description">
                    è¼¸å…¥è‚¡ç¥¨çš„é«˜é»èˆ‡ä½é»åƒ¹æ ¼ï¼Œç³»çµ±æœƒè‡ªå‹•è¨ˆç®—æ–æ³¢é‚£å¥‘å›æ’¤æ°´å¹³ï¼ˆæ”¯æ’ä½ï¼‰èˆ‡æ“´å±•æ°´å¹³ï¼ˆå£“åŠ›ä½ï¼‰ï¼Œä¸¦æ ¹æ“šå°è‚¡ Tick Size è¦å‰‡é€²è¡Œåƒ¹æ ¼ä¿®æ­£ã€‚
                </p>
                
                <form method="POST" action="/" id="fibonacciForm">
                <input type="hidden" name="form_type" value="fibonacci">
                <div class="form-group">
                        <label for="high_price" class="form-label">
                            é«˜é»åƒ¹æ ¼ (High Price)
                            <span class="required">*</span>
                        </label>
                    <input type="number" 
                           id="high_price" 
                           name="high_price" 
                               class="form-input"
                           step="0.01" 
                           min="0" 
                           required
                               placeholder="ä¾‹å¦‚: 580.00"
                           value="{{ request.form.get('high_price', '') if request.form else '' }}">
                        <p class="form-helper">è«‹è¼¸å…¥è‚¡ç¥¨çš„æœ€é«˜åƒ¹æ ¼</p>
                </div>
                
                <div class="form-group">
                        <label for="low_price" class="form-label">
                            ä½é»åƒ¹æ ¼ (Low Price)
                            <span class="required">*</span>
                        </label>
                    <input type="number" 
                           id="low_price" 
                           name="low_price" 
                               class="form-input"
                           step="0.01" 
                           min="0" 
                           required
                               placeholder="ä¾‹å¦‚: 500.00"
                           value="{{ request.form.get('low_price', '') if request.form else '' }}">
                        <p class="form-helper">è«‹è¼¸å…¥è‚¡ç¥¨çš„æœ€ä½åƒ¹æ ¼</p>
                </div>
                
                    <button type="submit" class="btn btn-primary">
                        è¨ˆç®—æ–æ³¢é‚£å¥‘æ”¯æ’ä½èˆ‡å£“åŠ›ä½
                    </button>
            </form>
            
            {% if fibonacci_error %}
                <div class="alert alert-error">
                    <span class="alert-icon">âš ï¸</span>
                    <div class="alert-content">
                        <div class="alert-title">è¨ˆç®—éŒ¯èª¤</div>
                        <div class="alert-message">{{ fibonacci_error }}</div>
                </div>
            </div>
            {% endif %}
            
            {% if support_levels or resistance_levels %}
                <div class="results-container show">
                    <div class="results-header">
                        <h3>è¨ˆç®—çµæœ</h3>
                    </div>
                
                {% if support_levels %}
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ›¡ï¸ æ½›åœ¨æ”¯æ’ä½ (æ–æ³¢é‚£å¥‘å›æ’¤)</h3>
                        </div>
                        <div class="table-wrapper">
                            <table class="table-support">
                        <thead>
                            <tr>
                                <th>å›æ’¤æ°´å¹³</th>
                                <th>æ”¯æ’åƒ¹æ ¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for level, price in support_levels %}
                            <tr>
                                        <td class="table-price">{{ "%.3f"|format(level) }}</td>
                                        <td class="table-price price-support">{{ "%.2f"|format(price) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                        </div>
                </div>
                {% endif %}
                
                {% if resistance_levels %}
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ“Š æ½›åœ¨å£“åŠ›ä½ (æ–æ³¢é‚£å¥‘æ“´å±•)</h3>
                        </div>
                        <div class="table-wrapper">
                            <table class="table-resistance">
                        <thead>
                            <tr>
                                <th>æ“´å±•æ°´å¹³</th>
                                <th>å£“åŠ›åƒ¹æ ¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for level, price in resistance_levels %}
                            <tr>
                                        <td class="table-price">{{ "%.3f"|format(level) }}</td>
                                        <td class="table-price price-resistance">{{ "%.2f"|format(price) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                        </div>
                </div>
                {% endif %}
                
                <div class="info-box">
                    <p><strong>é«˜é»åƒ¹æ ¼:</strong> {{ "%.2f"|format(high_price) }}</p>
                    <p><strong>ä½é»åƒ¹æ ¼:</strong> {{ "%.2f"|format(low_price) }}</p>
                    <p><strong>åƒ¹æ ¼å€é–“:</strong> {{ "%.2f"|format(range_value) }}</p>
                </div>
            </div>
            {% endif %}
            </div>
        </div>
        
        <!-- è‚¡ç¥¨è¨Šè™Ÿæ¨™ç±¤é  -->
        <div id="content-signals" class="tab-content {% if active_tab == 'signals' %}active{% endif %}">
        <div class="section">
                <div class="section-header">
                    <span class="icon">ğŸ“ˆ</span>
                    <h2>è‚¡ç¥¨è¨Šè™Ÿå„€è¡¨æ¿</h2>
                </div>
                <p class="section-description">
                    è¼¸å…¥å°è‚¡ä»£ç¢¼ï¼ˆå¦‚ 2330ã€2317ï¼‰ï¼Œç³»çµ±æœƒè‡ªå‹•æŸ¥è©¢ä¸¦åˆ†æè©²è‚¡ç¥¨çš„æ—¥ç·š/é€±ç·š KD é‡‘å‰è¨Šè™Ÿã€20MA ç«™ä¸Šåˆ¤æ–·ï¼Œä»¥åŠå¤šé‡æ”¯æ’å£“åŠ›ä½ã€‚
                </p>
                
                <form method="POST" action="/" id="signalsForm">
                <input type="hidden" name="form_type" value="signal">
                <div class="form-group">
                        <label for="ticker" class="form-label">
                            å°è‚¡ä»£ç¢¼
                            <span class="required">*</span>
                        </label>
                    <input type="text" 
                           id="ticker" 
                           name="ticker" 
                               class="form-input"
                           placeholder="ä¾‹å¦‚: 2330, 2317, 2454 (ç„¡éœ€è¼¸å…¥.TW)"
                           required
                               pattern="[0-9]{4}"
                               maxlength="4"
                           value="{{ request.form.get('ticker', '') if request.form and request.form.get('form_type') == 'signal' else '' }}">
                        <p class="form-helper">åªéœ€è¼¸å…¥ 4 ä½æ•¸å­—ä»£ç¢¼ï¼Œç³»çµ±æœƒè‡ªå‹•å˜—è©¦ä¸Šå¸‚/ä¸Šæ«ƒ</p>
                </div>
                
                    <button type="submit" class="btn btn-primary">
                        æŸ¥è©¢è‚¡ç¥¨è¨Šè™Ÿ
                    </button>
            </form>
            
            {% if signal_error %}
                <div class="alert alert-error">
                    <span class="alert-icon">âš ï¸</span>
                    <div class="alert-content">
                        <div class="alert-title">æŸ¥è©¢å¤±æ•—</div>
                        <div class="alert-message">{{ signal_error }}</div>
                </div>
            </div>
            {% endif %}
            
            {% if stock_signals %}
            <div class="signal-card">
                {% if stock_signals.stock_name %}
                    <div class="stock-header">
                    <h3>{{ stock_signals.stock_name }} ({{ stock_signals.ticker_display }})</h3>
                </div>
                {% endif %}
                
                <!-- æ—¥ç·šè¨Šè™Ÿå€å¡Š -->
                <div class="signal-group">
                    <h4 class="signal-group-title">ğŸ“Š æ—¥ç·šè¨Šè™Ÿ</h4>
                    <div class="signal-item">
                        <span class="signal-label">æ—¥ KD é‡‘å‰:</span>
                        <span class="signal-value {% if stock_signals.daily_kd_golden_cross %}signal-yes{% else %}signal-no{% endif %}">
                            {% if stock_signals.daily_kd_golden_cross %}âœ“ æ˜¯{% else %}âœ— å¦{% endif %}
                        </span>
                    </div>
                    {% if stock_signals.daily_k is not none %}
                    <div class="signal-item">
                        <span class="signal-label">æ—¥ K å€¼:</span>
                        <span class="signal-value">{{ "%.2f"|format(stock_signals.daily_k) }}</span>
                    </div>
                    <div class="signal-item">
                        <span class="signal-label">æ—¥ D å€¼:</span>
                        <span class="signal-value">{{ "%.2f"|format(stock_signals.daily_d) }}</span>
                    </div>
                    {% endif %}
                    <div class="signal-item">
                        <span class="signal-label">æ—¥ç·šåƒ¹æ ¼ç«™ä¸Š 20MA:</span>
                        <span class="signal-value {% if stock_signals.daily_price_above_ma20 %}signal-yes{% else %}signal-no{% endif %}">
                            {% if stock_signals.daily_price_above_ma20 %}âœ“ æ˜¯{% else %}âœ— å¦{% endif %}
                        </span>
                    </div>
                    {% if stock_signals.current_price is not none %}
                    <div class="signal-item">
                        <span class="signal-label">æ—¥ç·šç•¶å‰åƒ¹æ ¼:</span>
                        <span class="signal-value">{{ "%.2f"|format(stock_signals.current_price) }}</span>
                    </div>
                    {% endif %}
                    {% if stock_signals.daily_ma20 is not none %}
                    <div class="signal-item">
                        <span class="signal-label">æ—¥ç·š 20 æ—¥å‡ç·š:</span>
                        <span class="signal-value">{{ "%.2f"|format(stock_signals.daily_ma20) }}</span>
                    </div>
                    {% endif %}
                </div>
                
                <!-- é€±ç·šè¨Šè™Ÿå€å¡Š -->
                <div class="signal-group">
                    <h4 class="signal-group-title">ğŸ“ˆ é€±ç·šè¨Šè™Ÿ</h4>
                    <div class="signal-item">
                        <span class="signal-label">é€± KD é‡‘å‰:</span>
                        <span class="signal-value {% if stock_signals.weekly_kd_golden_cross %}signal-yes{% else %}signal-no{% endif %}">
                            {% if stock_signals.weekly_kd_golden_cross %}âœ“ æ˜¯{% else %}âœ— å¦{% endif %}
                        </span>
                    </div>
                    {% if stock_signals.weekly_k is not none %}
                    <div class="signal-item">
                        <span class="signal-label">é€± K å€¼:</span>
                        <span class="signal-value">{{ "%.2f"|format(stock_signals.weekly_k) }}</span>
                    </div>
                    <div class="signal-item">
                        <span class="signal-label">é€± D å€¼:</span>
                        <span class="signal-value">{{ "%.2f"|format(stock_signals.weekly_d) }}</span>
                    </div>
                    {% endif %}
                    <div class="signal-item">
                        <span class="signal-label">é€±ç·šåƒ¹æ ¼ç«™ä¸Š 20MA:</span>
                        <span class="signal-value {% if stock_signals.weekly_price_above_ma20 %}signal-yes{% else %}signal-no{% endif %}">
                            {% if stock_signals.weekly_price_above_ma20 %}âœ“ æ˜¯{% else %}âœ— å¦{% endif %}
                        </span>
                    </div>
                    {% if stock_signals.weekly_price is not none %}
                    <div class="signal-item">
                        <span class="signal-label">é€±ç·šç•¶å‰åƒ¹æ ¼:</span>
                        <span class="signal-value">{{ "%.2f"|format(stock_signals.weekly_price) }}</span>
                    </div>
                    {% endif %}
                    {% if stock_signals.weekly_ma20 is not none %}
                    <div class="signal-item">
                        <span class="signal-label">é€±ç·š 20 é€±å‡ç·š:</span>
                        <span class="signal-value">{{ "%.2f"|format(stock_signals.weekly_ma20) }}</span>
                    </div>
                    {% endif %}
                </div>
                
                <!-- å¤šé‡é—œéµæ”¯æ’èˆ‡å£“åŠ›ä½å€å¡Š -->
                {% if stock_signals.r1 is not none or stock_signals.r2 is not none or stock_signals.r3 is not none or stock_signals.s1 is not none or stock_signals.s2 is not none or stock_signals.s3 is not none %}
                <div class="signal-group" style="margin-top: 25px;">
                    <h4 class="signal-group-title">ğŸ¯ å¤šé‡é—œéµæ”¯æ’èˆ‡å£“åŠ›ä½ï¼ˆåˆ†å½¢æŒ‡æ¨™ï¼‰</h4>
                    
                    {% if stock_signals.support_resistance_error %}
                        <div class="alert alert-error">
                            <span class="alert-icon">âš ï¸</span>
                            <div class="alert-content">
                                <div class="alert-message">{{ stock_signals.support_resistance_error }}</div>
                            </div>
                    </div>
                    {% endif %}
                    
                        <div class="table-wrapper" style="margin-top: 15px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                    <tr style="background: var(--bg-gradient); color: var(--text-inverse);">
                                    <th style="padding: 12px; text-align: left; font-weight: 600; font-size: 14px;">åƒ¹ä½é¡å‹</th>
                                    <th style="padding: 12px; text-align: right; font-weight: 600; font-size: 14px;">åƒ¹æ ¼</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if stock_signals.r3 is not none %}
                                <tr style="border-bottom: 1px solid #f0f0f0; background-color: #fff5f5;">
                                    <td style="padding: 12px; font-weight: 600; color: #555;">å£“åŠ›ä½ R3ï¼ˆæœ€é ï¼‰</td>
                                    <td style="padding: 12px; text-align: right; font-weight: 700; font-size: 16px; color: #c0392b;">{{ "%.2f"|format(stock_signals.r3) }}</td>
                                </tr>
                                {% endif %}
                                {% if stock_signals.r2 is not none %}
                                <tr style="border-bottom: 1px solid #f0f0f0; background-color: #fff5f5;">
                                    <td style="padding: 12px; font-weight: 600; color: #555;">å£“åŠ›ä½ R2</td>
                                    <td style="padding: 12px; text-align: right; font-weight: 700; font-size: 16px; color: #e74c3c;">{{ "%.2f"|format(stock_signals.r2) }}</td>
                                </tr>
                                {% endif %}
                                {% if stock_signals.r1 is not none %}
                                <tr style="border-bottom: 2px solid #667eea; background-color: #fff5f5;">
                                    <td style="padding: 12px; font-weight: 600; color: #555;">å£“åŠ›ä½ R1ï¼ˆæœ€è¿‘ï¼‰</td>
                                    <td style="padding: 12px; text-align: right; font-weight: 700; font-size: 16px; color: #e74c3c;">{{ "%.2f"|format(stock_signals.r1) }}</td>
                                </tr>
                                {% endif %}
                                
                                <!-- ç•¶å‰åƒ¹æ ¼åˆ†éš”ç·š -->
                                {% if stock_signals.current_price is not none %}
                                    <tr style="background: var(--bg-gradient); border-top: 2px solid #667eea; border-bottom: 2px solid #667eea;">
                                    <td style="padding: 14px; text-align: center; font-weight: 700; font-size: 16px; color: white;" colspan="2">
                                        â•â•â• ç•¶å‰åƒ¹æ ¼ï¼š{{ "%.2f"|format(stock_signals.current_price) }} â•â•â•
                                    </td>
                                </tr>
                                {% endif %}
                                
                                {% if stock_signals.s1 is not none %}
                                <tr style="border-top: 2px solid #27ae60; background-color: #f0fff4;">
                                    <td style="padding: 12px; font-weight: 600; color: #555;">æ”¯æ’ä½ S1ï¼ˆæœ€è¿‘ï¼‰</td>
                                    <td style="padding: 12px; text-align: right; font-weight: 700; font-size: 16px; color: #27ae60;">{{ "%.2f"|format(stock_signals.s1) }}</td>
                                </tr>
                                {% endif %}
                                {% if stock_signals.s2 is not none %}
                                <tr style="border-bottom: 1px solid #f0f0f0; background-color: #f0fff4;">
                                    <td style="padding: 12px; font-weight: 600; color: #555;">æ”¯æ’ä½ S2</td>
                                    <td style="padding: 12px; text-align: right; font-weight: 700; font-size: 16px; color: #27ae60;">{{ "%.2f"|format(stock_signals.s2) }}</td>
                                </tr>
                                {% endif %}
                                {% if stock_signals.s3 is not none %}
                                <tr style="background-color: #f0fff4;">
                                    <td style="padding: 12px; font-weight: 600; color: #555;">æ”¯æ’ä½ S3ï¼ˆæœ€é ï¼‰</td>
                                    <td style="padding: 12px; text-align: right; font-weight: 700; font-size: 16px; color: #2ecc71;">{{ "%.2f"|format(stock_signals.s3) }}</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="info-box" style="margin-top: 15px;">
                        <p style="margin: 5px 0; color: #555; font-size: 13px;"><strong>èªªæ˜ï¼š</strong></p>
                        <p style="margin: 5px 0; color: #555; font-size: 12px;">â€¢ <strong>åˆ†å½¢æŒ‡æ¨™ (Fractals)</strong>ï¼šåƒè€ƒ TradingView çš„åˆ†å½¢æŒ‡æ¨™ï¼Œè­˜åˆ¥é«˜æ–¼/ä½æ–¼å·¦å³å„5æ ¹Kæ£’çš„é—œéµåƒ¹ä½</p>
                        <p style="margin: 5px 0; color: #555; font-size: 12px;">â€¢ <strong>å¤šé‡å£“åŠ›ä½ (R1-R3)</strong>ï¼šå¾éå»2å¹´æ•¸æ“šä¸­æ‰¾å‡º > ç•¶å‰åƒ¹æ ¼çš„åˆ†å½¢é«˜é»ï¼Œç”±è¿‘åˆ°é æ’åºï¼Œå–å‰3å€‹</p>
                        <p style="margin: 5px 0; color: #555; font-size: 12px;">â€¢ <strong>å¤šé‡æ”¯æ’ä½ (S1-S3)</strong>ï¼šå¾éå»2å¹´æ•¸æ“šä¸­æ‰¾å‡º < ç•¶å‰åƒ¹æ ¼çš„åˆ†å½¢ä½é»ï¼Œç”±è¿‘åˆ°é æ’åºï¼Œå–å‰3å€‹</p>
                        <p style="margin: 5px 0; color: #555; font-size: 12px;">â€¢ <strong>åƒ¹æ ¼ä¿®æ­£</strong>ï¼šæ‰€æœ‰åƒ¹æ ¼å·²æ ¹æ“šå°è‚¡å‡é™å–®ä½ (Tick Size) é€²è¡Œä¿®æ­£ï¼ˆå£“åŠ›ä½å‘ä¸‹å–æ•´ï¼Œæ”¯æ’ä½å‘ä¸Šå–æ•´ï¼‰</p>
                        <p style="margin: 5px 0; color: #555; font-size: 12px;">â€¢ <strong>éæ¿¾é‡è¤‡</strong>ï¼šè‡ªå‹•éæ¿¾é‡è¤‡çš„åƒ¹æ ¼å€¼ï¼Œç¢ºä¿æ¯å€‹åƒ¹ä½éƒ½æ˜¯å”¯ä¸€çš„</p>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}
            </div>
        </div>

        <!-- æ—ç¾¤ç†±åº¦åˆ†ææ¨™ç±¤é  -->
        <div id="content-themes" class="tab-content {% if active_tab == 'themes' %}active{% endif %}">
        <div class="section">
                <div class="section-header">
                    <span class="icon">ğŸ”¥</span>
                    <h2>æ—ç¾¤ç†±åº¦åˆ†æ</h2>
                </div>
                <p class="section-description">
                    åˆ†æç•¶æ—¥é«˜é€±è½‰ç‡è‚¡ç¥¨çš„æ—ç¾¤åˆ†å¸ƒï¼Œè‡ªå‹•å¾ TWSE å’Œ TPEx API è¼‰å…¥è³‡æ–™ï¼Œä¸¦æä¾›é€±è½‰ç‡åˆ†æå ±å‘Šèˆ‡æ³¨æ„è‚¡åˆ†æå ±å‘Šã€‚
                </p>
            
            <form id="themeAnalysisForm" onsubmit="analyzeTheme(event)">
                <div class="form-group">
                        <label for="top_n" class="form-label">å‰ N åï¼ˆé¸å¡«ï¼‰</label>
                    <input type="number" 
                           id="top_n" 
                           name="top_n" 
                               class="form-input"
                           placeholder="ä¾‹å¦‚: 50ï¼ˆç•™ç©ºå‰‡åˆ†ææ‰€æœ‰è³‡æ–™ï¼‰"
                           min="1"
                           max="500">
                        <p class="form-helper">é™åˆ¶åˆ†æå‰ N åé«˜é€±è½‰ç‡è‚¡ç¥¨ï¼Œç•™ç©ºå‰‡åˆ†ææ‰€æœ‰è³‡æ–™</p>
                </div>
                
                    <button type="submit" class="btn btn-secondary">
                        ğŸ“Š é–‹å§‹åˆ†æ
                    </button>
            </form>
            
                <div id="themeAnalysisLoading" class="loading-container">
                    <div class="spinner"></div>
                    <p class="loading-text">æ­£åœ¨è¼‰å…¥è³‡æ–™ä¸¦åˆ†æ...</p>
            </div>
            
                <div id="themeAnalysisError" class="alert alert-error hidden">
                    <span class="alert-icon">âš ï¸</span>
                    <div class="alert-content">
                        <div class="alert-title">åˆ†æå¤±æ•—</div>
                        <div class="alert-message" id="themeAnalysisErrorMsg"></div>
                    </div>
            </div>
            
                <div id="themeAnalysisResults" class="results-container">
                    <div id="themeAnalysisContent"></div>
            </div>
        </div>
        </div>
    </div>

    <script>
        // æ¨™ç±¤é åˆ‡æ›åŠŸèƒ½
        function switchTab(tabName) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active é¡åˆ¥
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
            const content = document.getElementById('content-' + tabName);
            if (content) {
                content.classList.add('active');
            }
            
            // æ·»åŠ  active é¡åˆ¥åˆ°é¸ä¸­çš„æŒ‰éˆ•
            const button = document.getElementById('tab-' + tabName);
            if (button) {
                button.classList.add('active');
            }
            
            // æ»¾å‹•åˆ°é ‚éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // é é¢è¼‰å…¥æ™‚ï¼Œæ ¹æ“šå¾Œç«¯åƒæ•¸è‡ªå‹•åˆ‡æ›åˆ°å°æ‡‰æ¨™ç±¤é 
        document.addEventListener('DOMContentLoaded', function() {
            const activeTab = '{{ active_tab }}';
            if (activeTab && activeTab !== 'fibonacci') {
                switchTab(activeTab);
            }
        });
        
        // è¡¨å–®æäº¤æ™‚é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        document.getElementById('fibonacciForm')?.addEventListener('submit', function(e) {
            const btn = this.querySelector('button[type="submit"]');
            if (btn) {
                btn.classList.add('btn-loading');
                btn.disabled = true;
            }
        });
        
        document.getElementById('signalsForm')?.addEventListener('submit', function(e) {
            const btn = this.querySelector('button[type="submit"]');
            if (btn) {
                btn.classList.add('btn-loading');
                btn.disabled = true;
            }
        });
        
        // æ—ç¾¤åˆ†æåŠŸèƒ½
        async function analyzeTheme(event) {
            event.preventDefault();
            
            const topN = document.getElementById('top_n').value;
            const loadingDiv = document.getElementById('themeAnalysisLoading');
            const errorDiv = document.getElementById('themeAnalysisError');
            const resultsDiv = document.getElementById('themeAnalysisResults');
            const contentDiv = document.getElementById('themeAnalysisContent');
            const submitBtn = event.target.querySelector('button[type="submit"]');
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­
            loadingDiv.classList.add('active');
            errorDiv.classList.add('hidden');
            resultsDiv.classList.remove('show');
            if (submitBtn) {
                submitBtn.classList.add('btn-loading');
                submitBtn.disabled = true;
            }
            
            try {
                const response = await fetch('/theme-analysis/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ top_n: topN || null })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // é¡¯ç¤ºçµæœ
                    displayThemeResults(data);
                    resultsDiv.classList.add('show');
                    // æ»¾å‹•åˆ°çµæœ
                    setTimeout(() => {
                        resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                } else {
                    // é¡¯ç¤ºéŒ¯èª¤
                    document.getElementById('themeAnalysisErrorMsg').textContent = data.error || 'åˆ†æå¤±æ•—';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('themeAnalysisErrorMsg').textContent = 'è«‹æ±‚å¤±æ•—: ' + error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                loadingDiv.classList.remove('active');
                if (submitBtn) {
                    submitBtn.classList.remove('btn-loading');
                    submitBtn.disabled = false;
                }
            }
        }
        
        function displayThemeResults(data) {
            const contentDiv = document.getElementById('themeAnalysisContent');
            const today = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
            
            // æº–å‚™æ¨™ç±¤é 
            const hasFocusReport = data.focus_report && data.focus_report.theme_heat_ranking && data.focus_report.theme_heat_ranking.length > 0;
            
            let html = '';
            
            // æ¨™ç±¤é æŒ‰éˆ•
            if (hasFocusReport) {
                html += '<div style="margin-bottom: 24px; border-bottom: 2px solid var(--border-light); display: flex; gap: 8px;">';
                html += '<button class="tab-btn active" onclick="switchReportTab(\'turnover\')" id="report-tab-turnover" style="padding: 12px 24px; border: none; border-bottom: 3px solid var(--color-primary); background: transparent; color: var(--color-primary); font-weight: 600; cursor: pointer; transition: all 0.3s;">ğŸ“ˆ é€±è½‰ç‡åˆ†æå ±å‘Š</button>';
                html += '<button class="tab-btn" onclick="switchReportTab(\'focus\')" id="report-tab-focus" style="padding: 12px 24px; border: none; border-bottom: 3px solid transparent; background: transparent; color: var(--text-secondary); font-weight: 600; cursor: pointer; transition: all 0.3s;">âš ï¸ æ³¨æ„è‚¡åˆ†æå ±å‘Š</button>';
                html += '</div>';
            }
            
            // é€±è½‰ç‡åˆ†æå ±å‘Š
            html += '<div id="report-content-turnover" class="report-tab-content">';
            if (data.turnover_report) {
                html += '<div class="results-header">';
                html += '<h3>ğŸ“… ' + today + '</h3>';
                html += '<p>é€±è½‰ç‡æ—ç¾¤ç†±åº¦åˆ†æå ±å‘Š</p>';
                html += '</div>';
                
                // æŒ‡æ¨™å¡ç‰‡
                html += '<div class="metric-grid">';
                html += '<div class="metric-card">';
                html += '<div class="metric-label">ğŸ“Š åˆ†ææ¨™çš„</div>';
                html += '<div class="metric-value">' + data.turnover_report.summary.total_stocks + ' æª”</div>';
                html += '</div>';
                
                html += '<div class="metric-card">';
                html += '<div class="metric-label">ğŸ”¥ æ´»èºæ—ç¾¤</div>';
                html += '<div class="metric-value">' + data.turnover_report.summary.total_themes + ' å€‹</div>';
                html += '</div>';
                
                html += '<div class="metric-card">';
                html += '<div class="metric-label">ğŸ“ˆ å¹³å‡é€±è½‰ç‡</div>';
                html += '<div class="metric-value">' + data.turnover_report.summary.avg_turnover.toFixed(2) + '%</div>';
                html += '</div>';
                html += '</div>';
                
                // æ—ç¾¤ç†±åº¦æ’è¡Œ
                html += '<div class="card">';
                html += '<div class="card-header">';
                html += '<h3 class="card-title">ğŸ”¥ æ—ç¾¤ç†±åº¦æ’è¡Œ</h3>';
                html += '<p style="color: var(--text-secondary); font-size: var(--font-size-small); margin-top: 8px;">ä¾å‡ºç¾æª”æ•¸èˆ‡å¹³å‡é€±è½‰ç‡æ’åº</p>';
                html += '</div>';
                
                if (data.turnover_report.theme_heat_ranking && data.turnover_report.theme_heat_ranking.length > 0) {
                    html += '<div class="table-wrapper">';
                    html += '<table class="table-support" id="turnover-theme-table">';
                    html += '<thead><tr><th>æ’å</th><th>æ—ç¾¤åç¨±</th><th style="text-align: right;">å‡ºç¾æª”æ•¸</th><th style="text-align: right;">å¹³å‡é€±è½‰ç‡ (%)</th><th>æ“ä½œ</th></tr></thead><tbody>';
                    data.turnover_report.theme_heat_ranking.forEach((theme, idx) => {
                        const safeThemeId = 'turnover-' + theme.theme_name.replace(/[^a-zA-Z0-9]/g, '-');
                        html += '<tr id="theme-row-' + safeThemeId + '">';
                        html += '<td style="font-weight: 600; color: var(--color-primary);">' + (idx + 1) + '</td>';
                        html += '<td>' + theme.theme_name + '</td>';
                        html += '<td style="text-align: right;">' + theme.count_in_topN + '</td>';
                        html += '<td style="text-align: right; font-weight: 600; color: var(--color-success);">' + theme.avg_turnover.toFixed(2) + '</td>';
                        html += '<td><button onclick="toggleThemeStocksInTable(\'turnover\', \'' + theme.theme_name + '\', \'' + safeThemeId + '\')" id="btn-' + safeThemeId + '" style="padding: 6px 12px; background: var(--color-primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">æŸ¥çœ‹å€‹è‚¡</button></td>';
                        html += '</tr>';
                        
                        // å€‹è‚¡æ¸…å–®å±•é–‹è¡Œï¼ˆåˆå§‹éš±è—ï¼‰
                        const themeStocks = data.turnover_report.theme_stocks && data.turnover_report.theme_stocks[theme.theme_name] || [];
                        if (themeStocks.length > 0) {
                            html += '<tr id="theme-stocks-row-' + safeThemeId + '" style="display: none;">';
                            html += '<td colspan="5" style="padding: 12px 16px; background: #f8f9fa; border-top: 1px solid #e5e7eb;">';
                            // ç°¡åŒ–é¡¯ç¤ºï¼šç›´æ¥åˆ—å‡ºå€‹è‚¡ï¼Œä¸ä½¿ç”¨åµŒå¥—è¡¨æ ¼
                            html += '<div style="display: flex; flex-wrap: wrap; gap: 12px;">';
                            themeStocks.forEach((stock, stockIdx) => {
                                html += '<div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">';
                                html += '<span style="font-weight: 600; color: var(--color-primary); font-size: 13px;">' + stock.code + '</span>';
                                html += '<span style="font-size: 13px; color: var(--text-primary);">' + stock.name + '</span>';
                                html += '</div>';
                            });
                            html += '</div></td></tr>';
                        }
                    });
                    html += '</tbody></table></div>';
                } else {
                    html += '<div class="alert alert-info">';
                    html += '<span class="alert-icon">ğŸ’¡</span>';
                    html += '<div class="alert-content"><div class="alert-message">ç›®å‰æ²’æœ‰åŒ¹é…åˆ°ä»»ä½•æ—ç¾¤çš„è‚¡ç¥¨ï¼Œè«‹ç¢ºèªè³‡æ–™æ˜¯å¦æ­£ç¢º</div></div>';
                    html += '</div>';
                }
                html += '</div>';
                
                // é€±è½‰ç‡å‰Nåæ¸…å–®
                if (data.turnover_report.turnover_stocks_list && data.turnover_report.turnover_stocks_list.length > 0) {
                    html += '<div class="card" style="margin-top: 24px;">';
                    html += '<div class="card-header">';
                    html += '<h3 class="card-title">ğŸ“Š é€±è½‰ç‡å‰ N åæ¸…å–® (' + data.turnover_report.turnover_stocks_list.length + ' æª”)</h3>';
                    html += '<p style="color: var(--text-secondary); font-size: var(--font-size-small); margin-top: 8px;">å®Œæ•´çš„é«˜é€±è½‰ç‡è‚¡ç¥¨æ¸…å–®</p>';
                    html += '</div>';
                    html += '<details style="margin-top: 16px;"><summary style="cursor: pointer; color: var(--color-primary); font-weight: 600; padding: 8px;">æŸ¥çœ‹å®Œæ•´æ¸…å–®ï¼ˆ' + data.turnover_report.turnover_stocks_list.length + ' æª”ï¼‰</summary>';
                    html += '<div class="table-wrapper" style="margin-top: 12px;">';
                    html += '<table><thead><tr style="background: var(--bg-gradient-success); color: white;"><th>æ’å</th><th>ä»£ç¢¼</th><th>è‚¡ç¥¨åç¨±</th>';
                    const firstTurnoverStock = data.turnover_report.turnover_stocks_list[0];
                    if (firstTurnoverStock && (firstTurnoverStock.chg_pct !== null && firstTurnoverStock.chg_pct !== undefined)) {
                        html += '<th style="text-align: right;">æ¼²è·Œ (%)</th>';
                    }
                    if (firstTurnoverStock && (firstTurnoverStock.turnover !== null && firstTurnoverStock.turnover !== undefined)) {
                        html += '<th style="text-align: right;">é€±è½‰ç‡ (%)</th>';
                    }
                    html += '</tr></thead><tbody>';
                    data.turnover_report.turnover_stocks_list.forEach((stock, idx) => {
                        html += '<tr><td style="font-weight: 600; color: var(--color-primary);">' + (idx + 1) + '</td>';
                        html += '<td>' + stock.code + '</td><td>' + stock.name + '</td>';
                        if (stock.chg_pct !== null && stock.chg_pct !== undefined) {
                            html += '<td style="text-align: right;">' + (stock.chg_pct >= 0 ? '+' : '') + stock.chg_pct.toFixed(2) + '</td>';
                        }
                        if (stock.turnover !== null && stock.turnover !== undefined) {
                            html += '<td style="text-align: right; font-weight: 600; color: var(--color-success);">' + stock.turnover.toFixed(2) + '</td>';
                        }
                        html += '</tr>';
                    });
                    html += '</tbody></table></div></details></div>';
                }
                
                // æœªåˆ†é¡è‚¡ç¥¨
                if (data.turnover_report.unclassified_stocks && data.turnover_report.unclassified_stocks.length > 0) {
                    html += '<div class="card" style="background: linear-gradient(135deg, #fef3c7 0%, #ffffff 100%); border-left: 4px solid var(--color-warning);">';
                    html += '<div class="card-header">';
                    html += '<h3 class="card-title">ğŸ“¦ æœªåˆ†é¡è‚¡ç¥¨ï¼š' + data.turnover_report.unclassified_stocks.length + ' æª”</h3>';
                    html += '<p style="color: var(--text-secondary); font-size: var(--font-size-small); margin-top: 8px;">é€™äº›è‚¡ç¥¨ä¸åœ¨ä»»ä½•æ—ç¾¤å®šç¾©ä¸­</p>';
                    html += '</div>';
                    html += '<details style="margin-top: 16px;"><summary style="cursor: pointer; color: var(--color-warning); font-weight: 600; padding: 8px;">æŸ¥çœ‹æœªåˆ†é¡è‚¡ç¥¨æ¸…å–®ï¼ˆ' + data.turnover_report.unclassified_stocks.length + ' æª”ï¼‰</summary>';
                    html += '<div class="table-wrapper" style="margin-top: 12px;">';
                    html += '<table><thead><tr style="background: var(--bg-gradient-warning); color: var(--text-primary);"><th>ä»£ç¢¼</th><th>è‚¡ç¥¨åç¨±</th>';
                    const firstStock = data.turnover_report.unclassified_stocks[0];
                    if (firstStock && (firstStock.chg_pct !== null && firstStock.chg_pct !== undefined)) {
                        html += '<th style="text-align: right;">æ¼²è·Œ (%)</th>';
                    }
                    if (firstStock && (firstStock.turnover !== null && firstStock.turnover !== undefined)) {
                        html += '<th style="text-align: right;">é€±è½‰ç‡ (%)</th>';
                    }
                    html += '</tr></thead><tbody>';
                    data.turnover_report.unclassified_stocks.forEach(stock => {
                        html += '<tr><td>' + stock.code + '</td><td>' + stock.name + '</td>';
                        if (stock.chg_pct !== null && stock.chg_pct !== undefined) {
                            html += '<td style="text-align: right;">' + (stock.chg_pct >= 0 ? '+' : '') + stock.chg_pct.toFixed(2) + '</td>';
                        }
                        if (stock.turnover !== null && stock.turnover !== undefined) {
                            html += '<td style="text-align: right;">' + stock.turnover.toFixed(2) + '</td>';
                        }
                        html += '</tr>';
                    });
                    html += '</tbody></table></div></details></div>';
                }
            }
            html += '</div>';
            
            // æ³¨æ„è‚¡åˆ†æå ±å‘Š
            if (hasFocusReport) {
                html += '<div id="report-content-focus" class="report-tab-content" style="display: none;">';
                html += '<div class="results-header">';
                html += '<h3>ğŸ“… ' + today + '</h3>';
                html += '<p>æ³¨æ„è‚¡æ—ç¾¤ç†±åº¦åˆ†æå ±å‘Š</p>';
                html += '</div>';
                
                // æŒ‡æ¨™å¡ç‰‡
                html += '<div class="metric-grid">';
                html += '<div class="metric-card">';
                html += '<div class="metric-label">ğŸ“Š æ³¨æ„è‚¡ç¸½æ•¸</div>';
                html += '<div class="metric-value">' + data.focus_report.summary.total_focus_stocks + ' æª”</div>';
                html += '</div>';
                
                html += '<div class="metric-card">';
                html += '<div class="metric-label">âœ… æœ‰é€±è½‰ç‡</div>';
                html += '<div class="metric-value">' + data.focus_report.summary.merged_count + ' æª”</div>';
                html += '</div>';
                
                html += '<div class="metric-card">';
                html += '<div class="metric-label">ğŸ“ˆ å¹³å‡é€±è½‰ç‡</div>';
                if (data.focus_report.summary.avg_turnover !== null && data.focus_report.summary.avg_turnover !== undefined) {
                    html += '<div class="metric-value">' + data.focus_report.summary.avg_turnover.toFixed(2) + '%</div>';
                } else {
                    html += '<div class="metric-value">N/A</div>';
                }
                html += '</div>';
                html += '</div>';
                
                // æ—ç¾¤ç†±åº¦æ’è¡Œ
                html += '<div class="card">';
                html += '<div class="card-header">';
                html += '<h3 class="card-title">ğŸ”¥ æ³¨æ„è‚¡æ—ç¾¤ç†±åº¦æ’è¡Œ</h3>';
                html += '<p style="color: var(--text-secondary); font-size: var(--font-size-small); margin-top: 8px;">ä¾å‡ºç¾æª”æ•¸èˆ‡å¹³å‡é€±è½‰ç‡æ’åº</p>';
                html += '</div>';
                
                if (data.focus_report.theme_heat_ranking && data.focus_report.theme_heat_ranking.length > 0) {
                    html += '<div class="table-wrapper">';
                    html += '<table class="table-resistance" id="focus-theme-table">';
                    html += '<thead><tr><th>æ’å</th><th>æ—ç¾¤åç¨±</th><th style="text-align: right;">å‡ºç¾æª”æ•¸</th><th style="text-align: right;">å¹³å‡é€±è½‰ç‡ (%)</th><th>æ“ä½œ</th></tr></thead><tbody>';
                    data.focus_report.theme_heat_ranking.forEach((theme, idx) => {
                        const safeThemeId = 'focus-' + theme.theme_name.replace(/[^a-zA-Z0-9]/g, '-');
                        html += '<tr id="theme-row-' + safeThemeId + '">';
                        html += '<td style="font-weight: 600; color: var(--color-primary);">' + (idx + 1) + '</td>';
                        html += '<td>' + theme.theme_name + '</td>';
                        html += '<td style="text-align: right;">' + theme.count_in_topN + '</td>';
                        html += '<td style="text-align: right; font-weight: 600; color: var(--color-error);">' + theme.avg_turnover.toFixed(2) + '</td>';
                        html += '<td><button onclick="toggleThemeStocksInTable(\'focus\', \'' + theme.theme_name + '\', \'' + safeThemeId + '\')" id="btn-' + safeThemeId + '" style="padding: 6px 12px; background: var(--color-error); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">æŸ¥çœ‹å€‹è‚¡</button></td>';
                        html += '</tr>';
                        
                        // å€‹è‚¡æ¸…å–®å±•é–‹è¡Œï¼ˆåˆå§‹éš±è—ï¼‰
                        const themeStocks = data.focus_report.theme_stocks && data.focus_report.theme_stocks[theme.theme_name] || [];
                        if (themeStocks.length > 0) {
                            html += '<tr id="theme-stocks-row-' + safeThemeId + '" style="display: none;">';
                            html += '<td colspan="5" style="padding: 12px 16px; background: #fef2f2; border-top: 1px solid #fee2e2;">';
                            // ç°¡åŒ–é¡¯ç¤ºï¼šç›´æ¥åˆ—å‡ºå€‹è‚¡ï¼Œä¸ä½¿ç”¨åµŒå¥—è¡¨æ ¼
                            html += '<div style="display: flex; flex-wrap: wrap; gap: 12px;">';
                            themeStocks.forEach((stock, stockIdx) => {
                                html += '<div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #fee2e2;">';
                                html += '<span style="font-weight: 600; color: var(--color-error); font-size: 13px;">' + stock.code + '</span>';
                                html += '<span style="font-size: 13px; color: var(--text-primary);">' + stock.name + '</span>';
                                html += '</div>';
                            });
                            html += '</div></td></tr>';
                        }
                    });
                    html += '</tbody></table></div>';
                } else {
                    html += '<div class="alert alert-info">';
                    html += '<span class="alert-icon">ğŸ’¡</span>';
                    html += '<div class="alert-content"><div class="alert-message">ç›®å‰æ²’æœ‰åŒ¹é…åˆ°ä»»ä½•æ—ç¾¤çš„æ³¨æ„è‚¡ï¼Œè«‹ç¢ºèªè³‡æ–™æ˜¯å¦æ­£ç¢º</div></div>';
                    html += '</div>';
                }
                html += '</div>';
                
                // æ³¨æ„è‚¡æ¸…å–®
                if (data.focus_report.focus_stocks_list && data.focus_report.focus_stocks_list.length > 0) {
                    html += '<div class="card" style="margin-top: 24px;">';
                    html += '<div class="card-header">';
                    html += '<h3 class="card-title">âš ï¸ æ³¨æ„è‚¡æ¸…å–® (' + data.focus_report.focus_stocks_list.length + ' æª”)</h3>';
                    html += '<p style="color: var(--text-secondary); font-size: var(--font-size-small); margin-top: 8px;">å®Œæ•´çš„æ³¨æ„è‚¡æ¸…å–®</p>';
                    html += '</div>';
                    html += '<details style="margin-top: 16px;"><summary style="cursor: pointer; color: var(--color-error); font-weight: 600; padding: 8px;">æŸ¥çœ‹å®Œæ•´æ¸…å–®ï¼ˆ' + data.focus_report.focus_stocks_list.length + ' æª”ï¼‰</summary>';
                    html += '<div class="table-wrapper" style="margin-top: 12px;">';
                    html += '<table><thead><tr style="background: var(--bg-gradient-error); color: white;"><th>ä»£ç¢¼</th><th>è‚¡ç¥¨åç¨±</th>';
                    const firstFocusStock = data.focus_report.focus_stocks_list[0];
                    if (firstFocusStock && (firstFocusStock.chg_pct !== null && firstFocusStock.chg_pct !== undefined)) {
                        html += '<th style="text-align: right;">æ¼²è·Œ (%)</th>';
                    }
                    if (firstFocusStock && (firstFocusStock.turnover !== null && firstFocusStock.turnover !== undefined)) {
                        html += '<th style="text-align: right;">é€±è½‰ç‡ (%)</th>';
                    }
                    html += '</tr></thead><tbody>';
                    data.focus_report.focus_stocks_list.forEach(stock => {
                        html += '<tr><td>' + stock.code + '</td><td>' + stock.name + '</td>';
                        if (stock.chg_pct !== null && stock.chg_pct !== undefined) {
                            html += '<td style="text-align: right;">' + (stock.chg_pct >= 0 ? '+' : '') + stock.chg_pct.toFixed(2) + '</td>';
                        }
                        if (stock.turnover !== null && stock.turnover !== undefined) {
                            html += '<td style="text-align: right;">' + stock.turnover.toFixed(2) + '</td>';
                        }
                        html += '</tr>';
                    });
                    html += '</tbody></table></div></details></div>';
                }
                
                // æœªåˆ†é¡æ³¨æ„è‚¡
                if (data.focus_report.unclassified_stocks && data.focus_report.unclassified_stocks.length > 0) {
                    html += '<div class="card" style="background: linear-gradient(135deg, #fef3c7 0%, #ffffff 100%); border-left: 4px solid var(--color-warning);">';
                    html += '<div class="card-header">';
                    html += '<h3 class="card-title">ğŸ“¦ æœªåˆ†é¡æ³¨æ„è‚¡ï¼š' + data.focus_report.unclassified_stocks.length + ' æª”</h3>';
                    html += '<p style="color: var(--text-secondary); font-size: var(--font-size-small); margin-top: 8px;">é€™äº›æ³¨æ„è‚¡ä¸åœ¨ä»»ä½•æ—ç¾¤å®šç¾©ä¸­</p>';
                    html += '</div>';
                    html += '<details style="margin-top: 16px;"><summary style="cursor: pointer; color: var(--color-warning); font-weight: 600; padding: 8px;">æŸ¥çœ‹æœªåˆ†é¡æ³¨æ„è‚¡æ¸…å–®ï¼ˆ' + data.focus_report.unclassified_stocks.length + ' æª”ï¼‰</summary>';
                    html += '<div class="table-wrapper" style="margin-top: 12px;">';
                    html += '<table><thead><tr style="background: var(--bg-gradient-warning); color: var(--text-primary);"><th>ä»£ç¢¼</th><th>è‚¡ç¥¨åç¨±</th>';
                    const firstFocusStock = data.focus_report.unclassified_stocks[0];
                    if (firstFocusStock && (firstFocusStock.chg_pct !== null && firstFocusStock.chg_pct !== undefined)) {
                        html += '<th style="text-align: right;">æ¼²è·Œ (%)</th>';
                    }
                    if (firstFocusStock && (firstFocusStock.turnover !== null && firstFocusStock.turnover !== undefined)) {
                        html += '<th style="text-align: right;">é€±è½‰ç‡ (%)</th>';
                    }
                    html += '</tr></thead><tbody>';
                    data.focus_report.unclassified_stocks.forEach(stock => {
                        html += '<tr><td>' + stock.code + '</td><td>' + stock.name + '</td>';
                        if (stock.chg_pct !== null && stock.chg_pct !== undefined) {
                            html += '<td style="text-align: right;">' + (stock.chg_pct >= 0 ? '+' : '') + stock.chg_pct.toFixed(2) + '</td>';
                        }
                        if (stock.turnover !== null && stock.turnover !== undefined) {
                            html += '<td style="text-align: right;">' + stock.turnover.toFixed(2) + '</td>';
                        }
                        html += '</tr>';
                    });
                    html += '</tbody></table></div></details></div>';
                }
                html += '</div>';
            }
            
            contentDiv.innerHTML = html;
        }
        
        function switchReportTab(tabName) {
            // éš±è—æ‰€æœ‰å ±å‘Šæ¨™ç±¤å…§å®¹
            document.querySelectorAll('.report-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active é¡åˆ¥
            document.querySelectorAll('#themeAnalysisContent .tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.borderBottomColor = 'transparent';
                btn.style.color = 'var(--text-secondary)';
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
            const content = document.getElementById('report-content-' + tabName);
            if (content) {
                content.style.display = 'block';
            }
            
            // æ·»åŠ  active é¡åˆ¥åˆ°é¸ä¸­çš„æŒ‰éˆ•
            const button = document.getElementById('report-tab-' + tabName);
            if (button) {
                button.classList.add('active');
                button.style.borderBottomColor = 'var(--color-primary)';
                button.style.color = 'var(--color-primary)';
            }
        }
        
        // åˆ‡æ›æ—ç¾¤å€‹è‚¡æ¸…å–®é¡¯ç¤ºï¼ˆåœ¨è¡¨æ ¼å…§å±•é–‹ï¼‰
        function toggleThemeStocksInTable(reportType, themeName, safeThemeId) {
            const stocksRow = document.getElementById('theme-stocks-row-' + safeThemeId);
            const button = document.getElementById('btn-' + safeThemeId);
            
            if (!stocksRow || !button) {
                console.error('æ‰¾ä¸åˆ°å…ƒç´ :', { stocksRow, button, safeThemeId });
                return;
            }
            
            // æª¢æŸ¥ç•¶å‰ç‹€æ…‹ï¼šä½¿ç”¨ getComputedStyle ä¾†ç²å–å¯¦éš›çš„é¡¯ç¤ºç‹€æ…‹
            const computedStyle = window.getComputedStyle(stocksRow);
            const isCurrentlyHidden = stocksRow.style.display === 'none' || 
                                     stocksRow.style.display === '' || 
                                     computedStyle.display === 'none';
            
            if (isCurrentlyHidden) {
                // å±•é–‹
                stocksRow.style.display = 'table-row';
                button.textContent = 'é—œé–‰æ¸…å–®';
                button.style.background = 'var(--color-warning)';
                // å¹³æ»‘æ»¾å‹•åˆ°å±•é–‹çš„è¡Œ
                setTimeout(() => {
                    stocksRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 50);
            } else {
                // é—œé–‰
                stocksRow.style.display = 'none';
                button.textContent = 'æŸ¥çœ‹å€‹è‚¡';
                button.style.background = reportType === 'turnover' ? 'var(--color-primary)' : 'var(--color-error)';
            }
        }
    </script>
    
</body>
</html>
